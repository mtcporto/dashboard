{% extends 'base.html' %}

{% block content %}
<div class="editor-container">
  <h2>Editor</h2>
  <div class="editor-path">
    <strong>Projeto:</strong> {{ nome }} / <strong>Arquivo:</strong> {{ path }}
  </div>
  <form method="post" id="editor-form">
    <div id="editor" style="height: 500px; width: 100%; border-radius: 4px;">{{ conteudo }}</div>
    <textarea name="conteudo" id="editor-content" style="display: none;">{{ conteudo }}</textarea>
    <div style="margin-top: 1rem; display: flex; justify-content: space-between;">
      <a href="{{ url_for('dashboard.projeto', nome=nome) }}" class="btn btn-secondary">← Voltar</a>
      <button type="submit" class="btn" id="save-btn">Salvar Alterações (Ctrl+S)</button>
    </div>
  </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace-builds/1.16.0/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace-builds/1.16.0/ext-language_tools.js"></script>
<script>
  // Configurar o editor Ace
  document.addEventListener('DOMContentLoaded', function() {
    ace.require("ace/ext/language_tools");
    const editor = ace.edit("editor");
    editor.setTheme("ace/theme/vs-dark");
    
    // Tentar determinar o modo baseado na extensão do arquivo
    const path = "{{ path }}";
    let mode = "ace/mode/text";
    
    if (path.endsWith('.py')) {
      mode = "ace/mode/python";
    } else if (path.endsWith('.html')) {
      mode = "ace/mode/html";
    } else if (path.endsWith('.js')) {
      mode = "ace/mode/javascript";
    } else if (path.endsWith('.css')) {
      mode = "ace/mode/css";
    } else if (path.endsWith('.json')) {
      mode = "ace/mode/json";
    } else if (path.endsWith('.md')) {
      mode = "ace/mode/markdown";
    } else if (path.endsWith('.xml')) {
      mode = "ace/mode/xml";
    } else if (path.endsWith('.sql')) {
      mode = "ace/mode/sql";
    } else if (path.endsWith('.sh') || path.endsWith('.bash')) {
      mode = "ace/mode/sh";
    } else if (path.endsWith('.txt')) {
      mode = "ace/mode/text";
    }
    
    editor.session.setMode(mode);
    editor.setOptions({
      fontSize: "14px",
      showPrintMargin: false,
      showGutter: true,
      highlightActiveLine: true,
      displayIndentGuides: true,
      fontFamily: "Consolas, 'Courier New', monospace",
      enableBasicAutocompletion: true,
      enableSnippets: true,
      enableLiveAutocompletion: true,
      scrollPastEnd: 0.5,
      tabSize: 4,
      useSoftTabs: true
    });
    
    // Configurar o formulário para salvar o conteúdo do editor
    const form = document.getElementById('editor-form');
    const textArea = document.getElementById('editor-content');
    
    form.addEventListener('submit', function() {
      textArea.value = editor.getValue();
    });
    
    // Adicionar atalho Ctrl+S
    editor.commands.addCommand({
      name: 'save',
      bindKey: {win: 'Ctrl-S', mac: 'Command-S'},
      exec: function() {
        textArea.value = editor.getValue();
        form.submit();
      }
    });
    
    // Configurar número da linha onde aconteceu erro
    const urlParams = new URLSearchParams(window.location.search);
    const errorLine = urlParams.get('errorLine');
    if (errorLine) {
      const line = parseInt(errorLine);
      editor.gotoLine(line, 0, true);
      editor.session.addMarker(new ace.Range(line-1, 0, line-1, 1), "ace_error-marker", "fullLine");
    }
    
    // Ajuste automático do editor para preencher o espaço disponível
    function resizeEditor() {
      const windowHeight = window.innerHeight;
      const editorTop = document.getElementById('editor').getBoundingClientRect().top;
      const footerHeight = 70; // Espaço para botões e margem
      const newHeight = windowHeight - editorTop - footerHeight;
      
      if (newHeight > 400) {
        document.getElementById('editor').style.height = newHeight + 'px';
        editor.resize();
      }
    }
    
    window.addEventListener('resize', resizeEditor);
    resizeEditor();
    
    // Destaque visual para o botão de salvar
    const saveBtn = document.getElementById('save-btn');
    saveBtn.addEventListener('mouseover', function() {
      this.textContent = "Salvar (Ctrl+S)";
    });
    
    saveBtn.addEventListener('mouseout', function() {
      this.textContent = "Salvar Alterações (Ctrl+S)";
    });
  });
</script>
{% endblock %}